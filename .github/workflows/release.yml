---
name: release

on:
  push:
    tags:
      - "*"

permissions:
  packages: write
  contents: write

jobs:
  goreleaser:
    runs-on: ubuntu-latest
    env:
      HAS_GPG_KEY: ${{ secrets.GPG_PRIVATE_KEY != '' }}
    steps:
      - name: Checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6
        with:
          fetch-depth: 0
      - name: Set up QEMU
        uses: docker/setup-qemu-action@c7c53464625b32c7a7e944ae62b3e17d2b600130 # v3
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@8d2750c68a42422c14e847fe6c8ac0403b4cbd6f # v3
      - name: Set up Go
        uses: actions/setup-go@7a3fe6cf4cb3a834922a1244abfce67bcef6a0c5 # v6
        with:
          go-version: ^1.21
      - name: Import GPG key for plugin signing
        id: import_gpg
        if: ${{ env.HAS_GPG_KEY == 'true' }}
        uses: crazy-max/ghaction-import-gpg@e89d40939c28e39f97cf32126055eeae86ba74ec # v6
        with:
          gpg_private_key: ${{ secrets.GPG_PRIVATE_KEY }}
          passphrase: ${{ secrets.GPG_PASSPHRASE }}
      - uses: docker/login-action@c94ce9fb468520275223c153574b00df6fe4bcc9 # v3
        with:
          registry: ghcr.io
          username: ${{ github.repository_owner }}
          password: ${{ secrets.GITHUB_TOKEN }}
      - name: Run GoReleaser
        uses: goreleaser/goreleaser-action@e435ccd777264be153ace6237001ef4d979d3a7a # v6
        with:
          distribution: goreleaser
          version: latest
          args: release --clean
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GPG_FINGERPRINT: ${{ steps.import_gpg.outputs.fingerprint || '' }}
      - name: Sign plugin tarballs for Helm v4 verification
        if: ${{ env.HAS_GPG_KEY == 'true' }}
        env:
          GPG_SIGNING_KEY: ${{ steps.import_gpg.outputs.fingerprint }}
          GPG_PASSPHRASE: ${{ secrets.GPG_PASSPHRASE }}
        run: |
          echo "Signing plugin tarballs with GPG for Helm v4 verification..."
          chmod +x sign-plugin.sh

          # Get version from tag
          VERSION="${GITHUB_REF#refs/tags/}"
          VERSION="${VERSION#v}"  # Remove 'v' prefix if present

          # Sign all tar.gz files (plugin packages)
          for tarball in dist/*.tar.gz; do
            if [ -f "$tarball" ]; then
              echo "Signing: $tarball"
              ./sign-plugin.sh "$VERSION" "$tarball" "$GPG_SIGNING_KEY" || {
                echo "Warning: Failed to sign $tarball"
              }
            fi
          done

          # List created .prov files
          echo "Created provenance files:"
          ls -lh dist/*.prov || echo "No .prov files created"
      - name: Set up Helm v4
        uses: azure/setup-helm@1a275c3b69536ee54be43f2070a358922e12c8d4 # v4
      - name: Test signed plugin tarballs with Helm v4
        if: ${{ env.HAS_GPG_KEY == 'true' }}
        run: |
          echo "Testing signed plugin tarballs with Helm..."

          # Create keyring from the public key in the repo
          KEYRING=$(mktemp)
          gpg --dearmor < signing-key.asc > "$KEYRING"

          FAILED=0
          for prov_file in dist/*.prov; do
            if [ -f "$prov_file" ]; then
              tarball="${prov_file%.prov}"
              if [ -f "$tarball" ]; then
                echo "Verifying: $tarball"
                helm plugin verify "$tarball" --keyring "$KEYRING" || {
                  echo "FAIL: Verification failed for $tarball"
                  cat "$prov_file"
                  FAILED=1
                }
              fi
            fi
          done

          if [ "$FAILED" -eq 1 ]; then
            exit 1
          fi
      - name: Upload provenance files to release
        if: ${{ env.HAS_GPG_KEY == 'true' }}
        uses: softprops/action-gh-release@a06a81a03ee405af7f2048a818ed3f03bbf83c7b # v2
        with:
          files: dist/*.prov
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
